<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cloud Student Attendance Tracker</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
body { font-family: 'Inter', sans-serif; background-color: #f7f9fc; }
.container { max-width: 1200px; margin: auto; padding: 1.5rem; }
.icon { font-size: 1.5rem; }
.btn-primary, .btn-secondary { border-radius: 0.5rem; font-weight: 600; padding: 0.75rem 1.25rem; }
.btn-primary { background-color: #4f46e5; color: #fff; }
.btn-secondary { background-color: #e5e7eb; color: #374151; }
.card { background-color: #fff; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); padding: 2rem; }
.badge { font-size: 0.875rem; font-weight: 500; padding: 0.25rem 0.75rem; border-radius: 9999px; }
.status-present { background-color: #d1fae5; color: #065f46; }
.status-late { background-color: #fef3c7; color: #92400e; }
.status-absent { background-color: #fee2e2; color: #991b1b; }
.status-excused { background-color: #e0f2fe; color: #075985; }
.modal { background-color: rgba(0,0,0,0.5); }
.loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background-color: rgba(255,255,255,0.9); display:flex; flex-direction: column; justify-content:center; align-items:center; z-index:100; }
.spinner { border:4px solid #f3f3f3; border-top:4px solid #4f46e5; border-radius:50%; width:40px; height:40px; animation: spin 1s linear infinite; }
@keyframes spin { 0% {transform:rotate(0deg);} 100% {transform:rotate(360deg);} }
.hidden { display: none; }
.table-responsive { overflow-x:auto; }
table { width:100%; min-width:768px; border-collapse:collapse; }
th, td { padding:0.75rem; text-align:left; border-bottom:1px solid #e5e7eb; }
th { background-color:#f9fafb; font-weight:600; text-transform:uppercase; font-size:0.875rem; color:#6b7280; }
</style>
</head>
<body class="bg-gray-100 min-h-screen">

<div id="loading-overlay" class="loading-overlay">
    <div class="spinner"></div>
    <p id="loading-message" class="mt-4 text-lg text-gray-700">Connecting to cloud database...</p>
    <p class="text-sm text-gray-500 mt-2">Your data will be available from any device.</p>
</div>

<div class="container mx-auto py-8 px-4">
    <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
        <div>
            <h1 class="text-3xl font-bold text-gray-800">Cloud Student Attendance Tracker</h1>
            <p class="text-gray-500 text-sm">A simple, interactive template with powerful features.</p>
        </div>
        <div class="flex items-center space-x-2 mt-4 sm:mt-0 text-sm text-gray-500">
            <span>User ID:</span>
            <span id="userIdDisplay" class="font-mono bg-gray-200 px-2 py-1 rounded-full text-xs">Loading...</span>
        </div>
    </header>

    <main id="main-content" class="hidden">
        <section id="dashboard" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="card p-6 text-center">
                <h3 class="text-xl font-semibold text-gray-700 mb-2">Total Present Today</h3>
                <p id="present-count" class="text-5xl font-bold text-green-600">0</p>
            </div>
            <div class="card p-6 text-center">
                <h3 class="text-xl font-semibold text-gray-700 mb-2">Total Absent Today</h3>
                <p id="absent-count" class="text-5xl font-bold text-red-600">0</p>
            </div>
            <div class="card p-6 text-center">
                <h3 class="text-xl font-semibold text-gray-700 mb-2">Total Students</h3>
                <p id="total-students-count" class="text-5xl font-bold text-gray-800">0</p>
            </div>
            <div class="card p-6 text-center">
                <h3 class="text-xl font-semibold text-gray-700 mb-2">Today's Attendance Rate</h3>
                <p id="attendance-rate" class="text-5xl font-bold text-blue-600">0%</p>
            </div>
        </section>

        <section id="controls" class="card mb-8">
            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center space-y-4 sm:space-y-0">
                <div class="w-full sm:w-1/3">
                    <input type="text" id="searchInput" placeholder="Search by name, ID, or class..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div class="flex flex-wrap items-center justify-end space-x-2 space-y-2 sm:space-y-0">
                    <button id="addTodayButton" class="btn-primary">Add Today's Date</button>
                    <button id="addStudentButton" class="btn-primary">Add New Student</button>
                    <button id="manageClassesButton" class="btn-secondary">Manage Classes</button>
                    <button id="exportCsvButton" class="btn-secondary">Export to CSV</button>
                </div>
            </div>
        </section>

        <section id="filters" class="mb-6">
            <div class="flex flex-wrap items-center space-x-2">
                <label for="dateFilter" class="text-gray-700 font-medium">Filter by date:</label>
                <select id="dateFilter" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"></select>
                <button id="allFilterButton" class="badge">All</button>
                <button id="presentFilterButton" class="badge status-present">Present</button>
                <button id="lateFilterButton" class="badge status-late">Late</button>
                <button id="absentFilterButton" class="badge status-absent">Absent</button>
                <button id="excusedFilterButton" class="badge status-excused">Excused</button>
            </div>
        </section>

        <section id="table-container" class="card table-responsive">
            <table id="attendanceTable">
                <thead>
                    <tr>
                        <th>Student ID</th>
                        <th>Student Name</th>
                        <th>Class/Section</th>
                        <th>Dates</th>
                        <th>Total Present</th>
                        <th>Total Absent</th>
                        <th>Attendance Rate (%)</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Table rows will be inserted here by JavaScript -->
                </tbody>
            </table>
        </section>
    </main>

    <!-- Modals (Add Student, Manage Classes, Mark Attendance) will go here -->

</div>

<script type="module">
import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

setLogLevel('debug');

const firebaseConfig = {
    apiKey: "AIzaSyC2_vwTgC-ElAUALXoK3wtLl9HxnHGUlWk",
    authDomain: "my-attendance-tracker-da791.firebaseapp.com",
    projectId: "my-attendance-tracker-da791",
    storageBucket: "my-attendance-tracker-da791.firebasestorage.app",
    messagingSenderId: "980096598714",
    appId: "1:980096598714:web:51746387331ce6955eb883",
    measurementId: "G-J7QSGNJJFB"
};

const appId = 'my-attendance-tracker-da791';
let app, db, auth, userId;

const loadingOverlay = document.getElementById('loading-overlay');
const loadingMessage = document.getElementById('loading-message');
const mainContent = document.getElementById('main-content');
const userIdDisplay = document.getElementById('userIdDisplay');

function showLoadingOverlay(message) {
    loadingMessage.textContent = message;
    loadingOverlay.classList.remove('hidden');
}

function hideLoadingOverlay() {
    loadingOverlay.classList.add('hidden');
    mainContent.classList.remove('hidden');
}

// ===== Initialize Firebase & Anonymous Auth =====
app = initializeApp(firebaseConfig);
auth = getAuth(app);
db = getFirestore(app);

async function initApp() {
    showLoadingOverlay("Connecting to cloud database...");
    try {
        const userCredential = await signInAnonymously(auth);
        userId = userCredential.user.uid;
        userIdDisplay.textContent = userId;

        // Initialize your data listeners here
        initializeDataListeners();

        hideLoadingOverlay();
    } catch (error) {
        console.error("Firebase auth failed:", error);
        loadingMessage.textContent = "Failed to connect. Check console logs.";
    }
}

// ===== Firestore listeners (students, classes, attendance) =====
function getStudentCollection() { return collection(db, `artifacts/${appId}/users/${userId}/students`); }
function getClassesCollection() { return collection(db, `artifacts/${appId}/users/${userId}/classes`); }
function getAttendanceCollection() { return collection(db, `artifacts/${appId}/users/${userId}/attendance`); }

let studentsData = {}, classesData = {}, attendanceData = {}, datesData = {}, currentFilterDate = null;
function initializeDataListeners() {
    if (!userId) return;

    onSnapshot(query(getStudentCollection()), snapshot => {
        studentsData = {};
        snapshot.forEach(doc => { studentsData[doc.id] = doc.data(); });
        renderAttendanceTable();
        updateDashboardStats();
    });

    onSnapshot(query(getClassesCollection()), snapshot => {
        classesData = {};
        snapshot.forEach(doc => { classesData[doc.id] = doc.data(); });
        renderClassList();
    });

    onSnapshot(query(getAttendanceCollection()), snapshot => {
        attendanceData = {}; datesData = {};
        snapshot.forEach(doc => {
            attendanceData[doc.id] = doc.data();
            const date = doc.data().date;
            if (date) datesData[date] = true;
        });
        updateDateFilterDropdown();
        renderAttendanceTable();
        updateDashboardStats();
    });
}

// ===================================
// ===== Main Application Logic =====
// ===================================

const studentDataCache = {};
const classDataCache = {};
let currentAttendanceData = {};
let uniqueDates = new Set();
let allStudents = [];

// DOM Elements
const addStudentButton = document.getElementById('addStudentButton');
const addTodayButton = document.getElementById('addTodayButton');
const manageClassesButton = document.getElementById('manageClassesButton');
const exportCsvButton = document.getElementById('exportCsvButton');
const attendanceTableBody = document.querySelector('#attendanceTable tbody');
const dateFilter = document.getElementById('dateFilter');
const searchInput = document.getElementById('searchInput');
const presentCountEl = document.getElementById('present-count');
const absentCountEl = document.getElementById('absent-count');
const totalStudentsCountEl = document.getElementById('total-students-count');
const attendanceRateEl = document.getElementById('attendance-rate');
const allFilterButton = document.getElementById('allFilterButton');
const presentFilterButton = document.getElementById('presentFilterButton');
const lateFilterButton = document.getElementById('lateFilterButton');
const absentFilterButton = document.getElementById('absentFilterButton');
const excusedFilterButton = document.getElementById('excusedFilterButton');

// Utility Functions
function formatDate(date) {
    return date.toISOString().split('T')[0];
}

function getTodayDate() {
    return formatDate(new Date());
}

function getStatusClass(status) {
    switch (status) {
        case 'Present': return 'status-present';
        case 'Late': return 'status-late';
        case 'Absent': return 'status-absent';
        case 'Excused': return 'status-excused';
        default: return '';
    }
}

// Modals
// Add Student Modal
const addStudentModal = document.createElement('div');
addStudentModal.className = 'modal fixed inset-0 flex items-center justify-center hidden z-50';
addStudentModal.innerHTML = `
<div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md mx-4">
    <h2 class="text-2xl font-bold mb-4">Add New Student</h2>
    <form id="addStudentForm">
        <div class="mb-4">
            <label for="studentName" class="block text-gray-700">Student Name</label>
            <input type="text" id="studentName" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
        </div>
        <div class="mb-4">
            <label for="studentId" class="block text-gray-700">Student ID</label>
            <input type="text" id="studentId" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
        </div>
        <div class="mb-4">
            <label for="studentClass" class="block text-gray-700">Class/Section</label>
            <input type="text" id="studentClass" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
        </div>
        <div class="flex justify-end space-x-2">
            <button type="button" id="cancelAddStudent" class="btn-secondary">Cancel</button>
            <button type="submit" class="btn-primary">Add Student</button>
        </div>
    </form>
</div>
`;
document.body.appendChild(addStudentModal);

// Manage Classes Modal
const manageClassesModal = document.createElement('div');
manageClassesModal.className = 'modal fixed inset-0 flex items-center justify-center hidden z-50';
manageClassesModal.innerHTML = `
<div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md mx-4">
    <h2 class="text-2xl font-bold mb-4">Manage Classes</h2>
    <ul id="classList" class="mb-4 space-y-2"></ul>
    <div class="flex space-x-2">
        <input type="text" id="newClassInput" placeholder="New Class Name" class="flex-grow border border-gray-300 rounded-md shadow-sm p-2">
        <button id="addClassButton" class="btn-primary">Add Class</button>
    </div>
    <div class="flex justify-end mt-4">
        <button type="button" id="closeManageClasses" class="btn-secondary">Done</button>
    </div>
</div>
`;
document.body.appendChild(manageClassesModal);

// Mark Attendance Modal
const markAttendanceModal = document.createElement('div');
markAttendanceModal.className = 'modal fixed inset-0 flex items-center justify-center hidden z-50';
markAttendanceModal.innerHTML = `
<div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md mx-4">
    <h2 class="text-2xl font-bold mb-4">Mark Attendance</h2>
    <div id="attendance-list"></div>
    <div class="flex justify-end mt-4">
        <button id="closeMarkAttendance" class="btn-secondary">Done</button>
    </div>
</div>
`;
document.body.appendChild(markAttendanceModal);

// Mark Attendance Today Modal
const markAttendanceTodayModal = document.createElement('div');
markAttendanceTodayModal.className = 'modal fixed inset-0 flex items-center justify-center hidden z-50';
markAttendanceTodayModal.innerHTML = `
<div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-2xl mx-4">
    <h2 class="text-2xl font-bold mb-4">Mark Attendance for Today</h2>
    <div class="table-responsive">
        <table class="w-full min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student Name</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Class/Section</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                </tr>
            </thead>
            <tbody id="markAttendanceTodayBody" class="bg-white divide-y divide-gray-200"></tbody>
        </table>
    </div>
    <div class="flex justify-end mt-4">
        <button id="saveAttendanceToday" class="btn-primary mr-2">Save All</button>
        <button id="closeMarkAttendanceToday" class="btn-secondary">Close</button>
    </div>
</div>
`;
document.body.appendChild(markAttendanceTodayModal);

// ===== UI Logic and Event Listeners =====
function updateDashboardStats() {
    const today = getTodayDate();
    const todayAttendance = Object.values(currentAttendanceData).filter(item => item.date === today);
    const present = todayAttendance.filter(item => item.status === 'Present' || item.status === 'Late').length;
    const absent = todayAttendance.filter(item => item.status === 'Absent' || item.status === 'Excused').length;
    const totalStudents = Object.keys(studentDataCache).length;
    
    presentCountEl.textContent = present;
    absentCountEl.textContent = absent;
    totalStudentsCountEl.textContent = totalStudents;
    
    const attendanceRate = totalStudents > 0 ? (present / totalStudents * 100).toFixed(0) : 0;
    attendanceRateEl.textContent = `${attendanceRate}%`;
}

function updateDateFilterDropdown() {
    dateFilter.innerHTML = '<option value="">All Dates</option>';
    const sortedDates = Array.from(uniqueDates).sort().reverse();
    sortedDates.forEach(date => {
        const option = document.createElement('option');
        option.value = date;
        option.textContent = date;
        dateFilter.appendChild(option);
    });
}

function renderAttendanceTable(filteredData = null) {
    attendanceTableBody.innerHTML = '';
    const displayData = filteredData || allStudents;

    if (displayData.length === 0) {
        attendanceTableBody.innerHTML = '<tr><td colspan="8" class="text-center text-gray-500 py-4">No students found. Please add new students.</td></tr>';
        return;
    }

    displayData.forEach(student => {
        const studentId = student.id;
        const studentRecord = currentAttendanceData[studentId] || {};
        const attendanceCount = Object.values(studentRecord.attendance || {}).filter(s => s === 'Present' || s === 'Late').length;
        const totalDates = Object.values(studentRecord.attendance || {}).length;
        const attendanceRate = totalDates > 0 ? (attendanceCount / totalDates * 100).toFixed(0) : 0;

        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${student.name}</td>
            <td>${student.studentId}</td>
            <td>${student.class}</td>
            <td class="text-center">${totalDates}</td>
            <td class="text-center">${attendanceCount}</td>
            <td class="text-center">${totalDates - attendanceCount}</td>
            <td class="text-center">${attendanceRate}%</td>
            <td>
                <button data-id="${studentId}" class="mark-attendance btn-primary text-xs px-2 py-1">Mark</button>
                <button data-id="${studentId}" class="delete-student btn-secondary text-xs px-2 py-1">Delete</button>
            </td>
        `;
        attendanceTableBody.appendChild(row);
    });
}

// Event Listeners
addStudentButton.addEventListener('click', () => {
    addStudentModal.classList.remove('hidden');
});

document.getElementById('cancelAddStudent').addEventListener('click', () => {
    addStudentModal.classList.add('hidden');
});

addStudentForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const studentName = document.getElementById('studentName').value;
    const studentId = document.getElementById('studentId').value;
    const studentClass = document.getElementById('studentClass').value;

    await addDoc(getStudentCollection(), {
        name: studentName,
        studentId: studentId,
        class: studentClass
    });

    addStudentModal.classList.add('hidden');
    addStudentForm.reset();
});

addTodayButton.addEventListener('click', () => {
    renderMarkAttendanceToday();
    markAttendanceTodayMo