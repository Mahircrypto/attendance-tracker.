<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cloud Student Attendance Tracker — All-in-one</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; background:#f3f4f6; }
    .card { background:white; border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,0.06); }
    .badge { display:inline-block; padding:0.25rem 0.5rem; border-radius:9999px; font-weight:600; font-size:0.75rem; }
    .status-present { background:#d1fae5; color:#065f46; }
    .status-absent  { background:#fee2e2; color:#991b1b; }
    .status-excuse  { background:#fef3c7; color:#92400e; }
    .status-late    { background:#e0e7ff; color:#1e40af; }
    .loading { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:60; background:rgba(255,255,255,0.85); }
    .hidden { display:none !important; }
    table { width:100%; border-collapse:collapse; }
    th, td { padding:0.75rem; border-bottom:1px solid #e6e9ef; text-align:left; vertical-align:middle; }
    th { background:#fafbfc; font-size:0.8rem; text-transform:uppercase; color:#6b7280; }
    .small { font-size:0.85rem; }
    .btn { padding:.45rem .8rem; border-radius:8px; font-weight:600; }
    .btn-ghost { background:#f3f4f6; color:#111827; }
    .btn-primary { background:#2563eb; color:white; }
    .status-btn { padding:.35rem .7rem; border-radius:8px; font-weight:600; cursor:pointer; }
    .flex-row-gap { display:flex; gap:.5rem; flex-wrap:wrap; align-items:center;}
    .message { position:fixed; bottom:16px; left:50%; transform:translateX(-50%); background:#111827; color:white; padding:.5rem 1rem; border-radius:8px; z-index:70; opacity:.95; }
  </style>
</head>
<body>

  <!-- Loading overlay -->
  <div id="loading" class="loading">
    <div class="card p-6 text-center">
      <div class="animate-spin border-4 border-t-4 border-gray-200 border-t-blue-500 rounded-full w-12 h-12 mx-auto"></div>
      <h3 class="mt-4 text-lg font-semibold">Connecting to cloud database...</h3>
      <p class="text-sm text-gray-500 mt-2">Signing in anonymously and syncing data.</p>
    </div>
  </div>

  <div id="app" class="max-w-6xl mx-auto p-6 hidden">
    <header class="mb-6">
      <div class="flex justify-between items-start gap-4">
        <div>
          <h1 class="text-3xl font-bold">Cloud Student Attendance Tracker</h1>
          <p class="text-gray-600 mt-1">Mark attendance fast — CSV export included.</p>
        </div>
        <div class="text-right small text-gray-600">
          <div>User ID: <span id="uidDisplay" class="font-mono text-sm bg-gray-100 px-2 py-1 rounded"></span></div>
        </div>
      </div>
    </header>

    <!-- top stats and controls -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
      <div class="card p-4 text-center">
        <div class="text-sm text-gray-500">Selected Date</div>
        <div class="mt-2">
          <input id="datePicker" type="date" class="border px-3 py-2 rounded" />
        </div>
      </div>

      <div class="card p-4">
        <div class="text-sm text-gray-500">Class filter</div>
        <div class="mt-2">
          <select id="classFilter" class="border px-3 py-2 rounded w-full">
            <option value="All">All classes</option>
            <option>Sanawy Tahfeez 1</option>
            <option>Mutawassit 3</option>
            <option>Mutawassit 2</option>
            <option>Mutawassit 1</option>
            <option>Ibtida'i 3</option>
            <option>Ibtida'i 2</option>
            <option>Ibtida'i 1</option>
          </select>
        </div>
      </div>

      <div class="card p-4 text-center">
        <div class="text-sm text-gray-500">Present</div>
        <div id="countPresent" class="text-2xl font-bold text-green-600 mt-2">0</div>
      </div>

      <div class="card p-4 text-center">
        <div class="text-sm text-gray-500">Absent</div>
        <div id="countAbsent" class="text-2xl font-bold text-red-600 mt-2">0</div>
      </div>
    </div>

    <!-- actions -->
    <div class="flex justify-between items-center gap-4 mb-4">
      <div class="flex items-center gap-2">
        <button id="openAddStudent" class="btn btn-primary">Add Student</button>
        <input id="searchInput" placeholder="Search by name / student id / class" class="border px-3 py-2 rounded w-96" />
      </div>
      <div class="flex items-center gap-2">
        <button id="exportCSV" class="btn btn-ghost">Export CSV (selected date/class)</button>
      </div>
    </div>

    <!-- students table -->
    <div class="card p-4">
      <div id="noData" class="text-center text-gray-500 py-10">No students found. Add students to get started.</div>

      <div class="overflow-x-auto">
        <table id="studentsTable" class="hidden">
          <thead>
            <tr>
              <th class="small">Name</th>
              <th class="small">Student ID</th>
              <th class="small">Class</th>
              <th class="small">Status</th>
              <th class="small">Actions</th>
            </tr>
          </thead>
          <tbody id="studentsTbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- add/edit student modal -->
  <div id="studentModal" class="fixed inset-0 flex items-center justify-center hidden z-50">
    <div class="absolute inset-0 bg-black/40" onclick="closeStudentModal()"></div>
    <div class="card p-6 z-60 w-full max-w-xl">
      <h3 id="studentModalTitle" class="text-xl font-bold mb-4">Add Student</h3>
      <form id="studentForm" class="space-y-3">
        <input type="hidden" id="studentDocId" />
        <div>
          <label class="block text-sm font-medium text-gray-700">Name *</label>
          <input id="studentName" required class="w-full border px-3 py-2 rounded" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Class *</label>
          <select id="studentClass" required class="w-full border px-3 py-2 rounded">
            <option value="">Select class</option>
            <option>Sanawy Tahfeez 1</option>
            <option>Mutawassit 3</option>
            <option>Mutawassit 2</option>
            <option>Mutawassit 1</option>
            <option>Ibtida'i 3</option>
            <option>Ibtida'i 2</option>
            <option>Ibtida'i 1</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Student ID (optional)</label>
          <input id="studentUID" class="w-full border px-3 py-2 rounded" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Parent Contact (optional)</label>
          <input id="studentContact" class="w-full border px-3 py-2 rounded" />
        </div>
        <div class="flex justify-end gap-2">
          <button type="button" onclick="closeStudentModal()" class="btn btn-ghost">Cancel</button>
          <button type="submit" class="btn btn-primary">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- small toast message -->
  <div id="toast" class="message hidden"></div>

  <!-- Firebase SDK (v11 modular) -->
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import {
    getFirestore, collection, doc, setDoc, addDoc, onSnapshot,
    query, where, getDocs, updateDoc, deleteDoc
  } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  // ---------- YOUR FIREBASE CONFIG ----------
  // You asked me to include your working config. Paste the config you provided:
  const firebaseConfig = {
    apiKey: "AIzaSyC2_vwTgC-ElAUALXoK3wtLl9HxnHGUlWk",
    authDomain: "my-attendance-tracker-da791.firebaseapp.com",
    projectId: "my-attendance-tracker-da791",
    storageBucket: "my-attendance-tracker-da791.firebasestorage.app",
    messagingSenderId: "980096598714",
    appId: "1:980096598714:web:51746387331ce6955eb883",
    measurementId: "G-J7QSGNJJFB"
  };
  // ------------------------------------------

  // DOM references
  const loadingEl = document.getElementById('loading');
  const appEl = document.getElementById('app');
  const uidDisplay = document.getElementById('uidDisplay');
  const datePicker = document.getElementById('datePicker');
  const classFilter = document.getElementById('classFilter');
  const studentsTbody = document.getElementById('studentsTbody');
  const studentsTable = document.getElementById('studentsTable');
  const noData = document.getElementById('noData');
  const searchInput = document.getElementById('searchInput');
  const countPresentEl = document.getElementById('countPresent');
  const countAbsentEl = document.getElementById('countAbsent');

  const openAddStudentBtn = document.getElementById('openAddStudent');
  const exportBtn = document.getElementById('exportCSV');

  // modal refs
  const studentModal = document.getElementById('studentModal');
  const studentForm = document.getElementById('studentForm');
  const studentModalTitle = document.getElementById('studentModalTitle');
  const studentDocIdInput = document.getElementById('studentDocId');
  const studentNameInput = document.getElementById('studentName');
  const studentClassSelect = document.getElementById('studentClass');
  const studentUIDInput = document.getElementById('studentUID');
  const studentContactInput = document.getElementById('studentContact');

  const toastEl = document.getElementById('toast');

  // app state
  let app, auth, db;
  let currentUserId = null;
  let students = []; // loaded students (from students collection)
  let attendanceMap = new Map(); // key => `${studentId}_${date}` => attendance doc
  let selectedDate = (new Date()).toISOString().slice(0,10); // default today
  let selectedClass = 'All';
  let searchTerm = '';

  // initialize UI defaults
  datePicker.value = selectedDate;

  function showToast(msg, timeout = 2500) {
    toastEl.textContent = msg;
    toastEl.classList.remove('hidden');
    setTimeout(()=> toastEl.classList.add('hidden'), timeout);
  }

  // show/hide loading
  function hideLoading() {
    loadingEl.classList.add('hidden');
    appEl.classList.remove('hidden');
  }
  function showLoadingMessage(text) {
    loadingEl.querySelector('h3')?.textContent = text;
  }

  // open/close student modal
  function openStudentModal(editStudent = null) {
    studentModal.classList.remove('hidden');
    if (editStudent) {
      studentModalTitle.textContent = 'Edit Student';
      studentDocIdInput.value = editStudent.id;
      studentNameInput.value = editStudent.name || '';
      studentClassSelect.value = editStudent.class_name || '';
      studentUIDInput.value = editStudent.student_uid || '';
      studentContactInput.value = editStudent.contact || '';
    } else {
      studentModalTitle.textContent = 'Add Student';
      studentDocIdInput.value = '';
      studentForm.reset();
    }
  }
  function closeStudentModal() {
    studentModal.classList.add('hidden');
  }

  // utility: format YYYY-MM-DD
  function toYMD(date) {
    const d = new Date(date);
    return d.toISOString().slice(0,10);
  }

  // ---------- Firestore data model chosen ----------
  // students collection: users/{uid}/students -> documents with { name, student_uid, class_name, contact, created_at }
  // attendance collection: users/{uid}/attendance -> documents keyed by `${studentId}_${date}`
  // attendance doc: { studentId, studentName, studentUid, class_name, date: 'YYYY-MM-DD', status, contact, timestamp }
  // This single attendance collection makes it easy to query by date and class for CSV/export.
  // --------------------------------------------------

  // Initialize firebase and sign in anonymously
  async function init() {
    try {
      app = initializeApp(firebaseConfig);
      auth = getAuth(app);
      db = getFirestore(app);

      // auth state
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          currentUserId = user.uid;
          uidDisplay.textContent = currentUserId;
          hideLoading();
          // start listeners
          startStudentsListener();
          startAttendanceListener();
        } else {
          // sign in anonymously
          try {
            await signInAnonymously(auth);
          } catch (err) {
            console.error('Auth error', err);
            showLoadingMessage('Auth failed — check console.');
          }
        }
      });
    } catch (err) {
      console.error('Initialization error', err);
      showLoadingMessage('Initialization failed. Check console.');
    }
  }

  // students listener (realtime)
  function startStudentsListener() {
    const studentsCol = collection(db, `users/${currentUserId}/students`);
    onSnapshot(studentsCol, (snapshot) => {
      students = [];
      snapshot.forEach(d => {
        students.push({ id: d.id, ...d.data() });
      });
      renderTable();
    }, (err) => {
      console.error('students listener error', err);
    });
  }

  // attendance listener (realtime) — listens to attendance documents for selectedDate (and updates map)
  let attendanceUnsub = null;
  function startAttendanceListener() {
    // we will listen to all attendance docs for the user (could be large).
    // Instead we maintain attendance up-to-date by listening to the attendance collection and filtering locally.
    const attendanceCol = collection(db, `users/${currentUserId}/attendance`);
    if (attendanceUnsub) attendanceUnsub(); // unsubscribe previous
    attendanceUnsub = onSnapshot(attendanceCol, (snapshot) => {
      attendanceMap.clear();
      snapshot.forEach(d => {
        const data = d.data();
        // key is stored as doc id; but we'll compute key studentId_date for quick lookup
        const key = `${data.studentId}_${data.date}`;
        attendanceMap.set(key, { id: d.id, ...data });
      });
      renderTable();
    }, (err) => {
      console.error('attendance listener error', err);
    });
  }

  // mark attendance (upsert)
  async function markAttendance(student, date, status) {
    try {
      const key = `${student.id}_${date}`;
      const docId = `${student.id}_${date}`; // deterministic id for easy upsert
      const ref = doc(db, `users/${currentUserId}/attendance`, docId);
      await setDoc(ref, {
        studentId: student.id,
        studentName: student.name,
        studentUid: student.student_uid || '',
        class_name: student.class_name,
        date,
        status,
        contact: student.contact || '',
        timestamp: new Date().toISOString()
      });
      showToast(`Marked ${student.name} as ${status}`);
    } catch (err) {
      console.error('markAttendance error', err);
      showToast('Error saving attendance (check console)');
    }
  }

  // delete attendance (optional utility)
  async function deleteAttendance(studentId, date) {
    try {
      const docId = `${studentId}_${date}`;
      await deleteDoc(doc(db, `users/${currentUserId}/attendance`, docId));
    } catch (err) {
      console.error('deleteAttendance error', err);
    }
  }

  // add/edit student
  async function saveStudent(e) {
    e.preventDefault();
    const docId = studentDocIdInput.value;
    const name = studentNameInput.value.trim();
    const class_name = studentClassSelect.value;
    const student_uid = studentUIDInput.value.trim();
    const contact = studentContactInput.value.trim();

    if (!name || !class_name) {
      showToast('Name and Class are required');
      return;
    }

    try {
      if (docId) {
        // update
        const ref = doc(db, `users/${currentUserId}/students`, docId);
        await updateDoc(ref, { name, class_name, student_uid, contact });
        showToast('Student updated');
      } else {
        // add
        await addDoc(collection(db, `users/${currentUserId}/students`), {
          name, class_name, student_uid, contact, created_at: new Date().toISOString()
        });
        showToast('Student added');
      }
      closeStudentModal();
    } catch (err) {
      console.error('saveStudent error', err);
      showToast('Error saving student');
    }
  }

  // delete student
  async function deleteStudent(studentId) {
    if (!confirm('Delete this student? This will remove the student document (attendance remains unless you delete attendance docs separately).')) return;
    try {
      await deleteDoc(doc(db, `users/${currentUserId}/students`, studentId));
      showToast('Student deleted');
    } catch (err) {
      console.error('deleteStudent error', err);
      showToast('Error deleting student');
    }
  }

  // render function
  function renderTable() {
    // apply filters: classFilter, datePicker, search
    selectedDate = datePicker.value || selectedDate;
    selectedClass = classFilter.value || 'All';
    searchTerm = (searchInput.value || '').toLowerCase().trim();

    // build filtered list
    let list = students.slice();
    if (selectedClass !== 'All') list = list.filter(s => s.class_name === selectedClass);
    if (searchTerm) {
      list = list.filter(s => {
        const combined = `${s.name} ${s.student_uid || ''} ${s.class_name || ''} ${s.contact || ''}`.toLowerCase();
        return combined.includes(searchTerm);
      });
    }

    // update table visibility
    if (list.length === 0) {
      noData.classList.remove('hidden');
      studentsTable.classList.add('hidden');
      countPresentEl.textContent = '0';
      countAbsentEl.textContent = '0';
      return;
    } else {
      noData.classList.add('hidden');
      studentsTable.classList.remove('hidden');
    }

    studentsTbody.innerHTML = '';

    // compute counts for selected date/class
    let presentCount = 0, absentCount = 0;
    for (const s of list) {
      const attKey = `${s.id}_${selectedDate}`;
      const att = attendanceMap.get(attKey);
      const status = att ? att.status : '—';
      if (status === 'Present') presentCount++;
      if (status === 'Absent') absentCount++;

      const row = document.createElement('tr');
      row.innerHTML = `
        <td class="small">${escapeHtml(s.name)}</td>
        <td class="small">${escapeHtml(s.student_uid || '')}</td>
        <td class="small">${escapeHtml(s.class_name || '')}</td>
        <td class="small">
          ${renderStatusBadge(status)}
        </td>
        <td class="small">
          <div class="flex-row-gap">
            <button class="status-btn btn-present small" data-action="status" data-id="${s.id}" data-status="Present">Present</button>
            <button class="status-btn btn-absent small" data-action="status" data-id="${s.id}" data-status="Absent">Absent</button>
            <button class="status-btn btn-excuse small" data-action="status" data-id="${s.id}" data-status="Excuse">Excuse</button>
            <button class="status-btn btn-late small" data-action="status" data-id="${s.id}" data-status="Late">Late</button>
            <button class="btn btn-ghost small" data-action="edit" data-id="${s.id}">Edit</button>
            <button class="btn btn-ghost small" data-action="delete" data-id="${s.id}">Delete</button>
          </div>
        </td>
      `;
      studentsTbody.appendChild(row);
    }

    countPresentEl.textContent = presentCount;
    countAbsentEl.textContent = absentCount;

    // attach event listeners for newly created buttons
    studentsTbody.querySelectorAll('button').forEach(btn => {
      const action = btn.dataset.action;
      const id = btn.dataset.id;
      if (action === 'status') {
        btn.addEventListener('click', async (ev) => {
          const status = ev.currentTarget.dataset.status;
          const student = students.find(x => x.id === id);
    